# PostgreSQL Backup CronJob
# Performs daily backups to S3/MinIO with retention management
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: backup-scripts
  namespace: testforge-data
data:
  backup.sh: |
    #!/bin/bash
    set -e

    # Configuration
    BACKUP_DIR="/tmp/backups"
    TIMESTAMP=$(date +%Y%m%d_%H%M%S)
    BACKUP_FILE="testforge_backup_${TIMESTAMP}.sql.gz"
    RETENTION_DAYS=${RETENTION_DAYS:-7}

    echo "Starting PostgreSQL backup at $(date)"

    # Create backup directory
    mkdir -p ${BACKUP_DIR}

    # Perform backup with pg_dump
    echo "Creating database backup..."
    PGPASSWORD="${POSTGRES_PASSWORD}" pg_dump \
      -h "${POSTGRES_HOST}" \
      -p "${POSTGRES_PORT:-5432}" \
      -U "${POSTGRES_USER}" \
      -d "${POSTGRES_DB}" \
      --format=plain \
      --no-owner \
      --no-acl \
      | gzip > "${BACKUP_DIR}/${BACKUP_FILE}"

    # Get backup size
    BACKUP_SIZE=$(ls -lh "${BACKUP_DIR}/${BACKUP_FILE}" | awk '{print $5}')
    echo "Backup created: ${BACKUP_FILE} (${BACKUP_SIZE})"

    # Upload to S3/MinIO
    echo "Uploading to S3..."
    mc alias set backup http://${S3_ENDPOINT} ${S3_ACCESS_KEY} ${S3_SECRET_KEY}
    mc cp "${BACKUP_DIR}/${BACKUP_FILE}" backup/${S3_BUCKET}/backups/postgres/

    # Verify upload
    if mc ls backup/${S3_BUCKET}/backups/postgres/${BACKUP_FILE} > /dev/null 2>&1; then
      echo "Upload successful"
    else
      echo "Upload failed!"
      exit 1
    fi

    # Cleanup old backups from S3 (keep last RETENTION_DAYS days)
    echo "Cleaning up old backups (keeping last ${RETENTION_DAYS} days)..."
    CUTOFF_DATE=$(date -d "-${RETENTION_DAYS} days" +%Y%m%d)
    mc ls backup/${S3_BUCKET}/backups/postgres/ | while read -r line; do
      FILE=$(echo "$line" | awk '{print $NF}')
      # Extract date from filename (testforge_backup_YYYYMMDD_HHMMSS.sql.gz)
      FILE_DATE=$(echo "$FILE" | sed -n 's/testforge_backup_\([0-9]\{8\}\)_.*/\1/p')
      if [ -n "$FILE_DATE" ] && [ "$FILE_DATE" -lt "$CUTOFF_DATE" ]; then
        echo "Deleting old backup: $FILE"
        mc rm backup/${S3_BUCKET}/backups/postgres/${FILE}
      fi
    done

    # Cleanup local backup
    rm -f "${BACKUP_DIR}/${BACKUP_FILE}"

    echo "Backup completed successfully at $(date)"

  restore.sh: |
    #!/bin/bash
    set -e

    # Usage: restore.sh <backup_file>
    if [ -z "$1" ]; then
      echo "Usage: $0 <backup_file>"
      echo "Available backups:"
      mc alias set backup http://${S3_ENDPOINT} ${S3_ACCESS_KEY} ${S3_SECRET_KEY}
      mc ls backup/${S3_BUCKET}/backups/postgres/
      exit 1
    fi

    BACKUP_FILE=$1
    RESTORE_DIR="/tmp/restore"

    echo "Starting restore from ${BACKUP_FILE}"

    mkdir -p ${RESTORE_DIR}

    # Download backup
    echo "Downloading backup..."
    mc alias set backup http://${S3_ENDPOINT} ${S3_ACCESS_KEY} ${S3_SECRET_KEY}
    mc cp backup/${S3_BUCKET}/backups/postgres/${BACKUP_FILE} ${RESTORE_DIR}/

    # Decompress and restore
    echo "Restoring database..."
    gunzip -c "${RESTORE_DIR}/${BACKUP_FILE}" | PGPASSWORD="${POSTGRES_PASSWORD}" psql \
      -h "${POSTGRES_HOST}" \
      -p "${POSTGRES_PORT:-5432}" \
      -U "${POSTGRES_USER}" \
      -d "${POSTGRES_DB}"

    # Cleanup
    rm -rf ${RESTORE_DIR}

    echo "Restore completed successfully"
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: postgres-backup
  namespace: testforge-data
spec:
  schedule: "0 2 * * *"  # Daily at 2 AM UTC
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      backoffLimit: 2
      activeDeadlineSeconds: 3600  # 1 hour timeout
      template:
        spec:
          restartPolicy: OnFailure
          containers:
            - name: backup
              image: minio/mc:latest
              command:
                - /bin/sh
                - -c
                - |
                  # Install PostgreSQL client
                  apk add --no-cache postgresql-client bash
                  # Run backup script
                  /scripts/backup.sh
              env:
                - name: POSTGRES_HOST
                  value: postgres.testforge-data.svc.cluster.local
                - name: POSTGRES_PORT
                  value: "5432"
                - name: POSTGRES_USER
                  valueFrom:
                    secretKeyRef:
                      name: postgres-secret
                      key: POSTGRES_USER
                - name: POSTGRES_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: postgres-secret
                      key: POSTGRES_PASSWORD
                - name: POSTGRES_DB
                  valueFrom:
                    secretKeyRef:
                      name: postgres-secret
                      key: POSTGRES_DB
                - name: S3_ENDPOINT
                  value: minio.testforge-data.svc.cluster.local:9000
                - name: S3_ACCESS_KEY
                  valueFrom:
                    secretKeyRef:
                      name: minio-secret
                      key: MINIO_ROOT_USER
                - name: S3_SECRET_KEY
                  valueFrom:
                    secretKeyRef:
                      name: minio-secret
                      key: MINIO_ROOT_PASSWORD
                - name: S3_BUCKET
                  value: testforge
                - name: RETENTION_DAYS
                  value: "7"
              volumeMounts:
                - name: scripts
                  mountPath: /scripts
              resources:
                requests:
                  memory: "128Mi"
                  cpu: "100m"
                limits:
                  memory: "512Mi"
                  cpu: "500m"
          volumes:
            - name: scripts
              configMap:
                name: backup-scripts
                defaultMode: 0755
---
# Manual backup job (for on-demand backups)
apiVersion: batch/v1
kind: Job
metadata:
  name: postgres-backup-manual
  namespace: testforge-data
  labels:
    app: postgres-backup
    type: manual
spec:
  ttlSecondsAfterFinished: 86400  # Cleanup after 24 hours
  template:
    spec:
      restartPolicy: OnFailure
      containers:
        - name: backup
          image: minio/mc:latest
          command:
            - /bin/sh
            - -c
            - |
              apk add --no-cache postgresql-client bash
              /scripts/backup.sh
          env:
            - name: POSTGRES_HOST
              value: postgres.testforge-data.svc.cluster.local
            - name: POSTGRES_PORT
              value: "5432"
            - name: POSTGRES_USER
              valueFrom:
                secretKeyRef:
                  name: postgres-secret
                  key: POSTGRES_USER
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgres-secret
                  key: POSTGRES_PASSWORD
            - name: POSTGRES_DB
              valueFrom:
                secretKeyRef:
                  name: postgres-secret
                  key: POSTGRES_DB
            - name: S3_ENDPOINT
              value: minio.testforge-data.svc.cluster.local:9000
            - name: S3_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: minio-secret
                  key: MINIO_ROOT_USER
            - name: S3_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: minio-secret
                  key: MINIO_ROOT_PASSWORD
            - name: S3_BUCKET
              value: testforge
            - name: RETENTION_DAYS
              value: "7"
          volumeMounts:
            - name: scripts
              mountPath: /scripts
          resources:
            requests:
              memory: "128Mi"
              cpu: "100m"
            limits:
              memory: "512Mi"
              cpu: "500m"
      volumes:
        - name: scripts
          configMap:
            name: backup-scripts
            defaultMode: 0755
